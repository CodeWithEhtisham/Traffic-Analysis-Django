{% extends 'analysis_base.html'%} 
{% load static %}
<style>
  .card {
    transition: transform 0.2s ease;
    box-shadow: 0 4px 6px 0 rgba(22, 22, 26, 0.18);
    border-radius: 0;
    /* border: 0; */
    /* margin-bottom: 1.5em; */
  }

  .card:hover {
    transform: scale(1.1);
  }
</style>
{% block content%}

<body>
    <div class="main-wrapper">
      {% include 'sidebar.html'%}
    <div class="page-wrapper">
        {% include 'navbar.html'%}
      <div class="page-content">
        
        <div
          class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
          <div>
            <h4 class="mb-3 mb-md-0">Welcome to Traffic Monitoring System</h4>
          </div>
          <div class="d-flex align-items-center flex-wrap text-nowrap">

            <a type="button" class="btn btn-outline-info btn-icon-text mr-2 d-none d-md-block"
                href="{% url 'history' %}">
                <i class="btn-icon-prepend" data-feather="activity"></i>
                History
            </a>
            <a type="button" class="btn btn-outline-primary btn-icon-text mr-2 mb-2 mb-md-0"
                href="{% url 'video_analysis' %}">
                <i class="btn-icon-prepend" data-feather="video"></i>
                Video Analysis
            </a>
            <a type="button" class="btn btn-primary btn-icon-text mb-2 mb-md-0"
                href="{% url 'index' %}">
                <i class="btn-icon-prepend" data-feather="bar-chart"></i>
                Live Stream Analysis
            </a>
        </div>
        </div>

        <div class="row">
          <!-- Location -->
          {% for site in site_names%}

          <div class="col-lg-5 col-xl-6 grid-margin stretch-card">
            <div class="card">
              <div class="card-body p-0">
                <h4 class="p-3 text-center">{{site}}</h4>
                <a href="{% url 'dashboard' site_name=site %}">
                  <!-- video -->
                  <div>
                    <img
                      src="{% static 'images/map.PNG'%}"
                      alt="stream2"
                      style="height: 400px; width: 100%"
                      id="{{site}}"
                    />
                  </div>
                </a>
              </div>

              <div class="card-footer">
                <div class="row m-2">
                  <div class="col-5 d-flex justify-content-end">
                    <div>
                      <label
                        class="d-flex align-items-center justify-content-end tx-24 text-uppercase font-weight-bold"
                        >yesterday Total Traffic
                        <span
                          class="p-1 ml-1 rounded-circle bg-primary-muted"
                        ></span
                      ></label>
                      <h5
                        class="font-weight-bold p-1 ml-5"
                        style="font-size: large"
                        id="yesterday_count"
                      >
                        IN:<span id="{{site}}_in_yes">0</span> | OUT:<span id="{{site}}_out_yes">0</span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-2 d-flex justify-content-end vr"></div>
                  <div class="col-5">
                    <div>
                      <label
                        class="d-flex align-items-center tx-32 text-uppercase font-weight-bold"
                        ><span class="p-1 mr-1 rounded-circle bg-primary"></span
                        >Today Total Traffic</label
                      >
                      <!-- </label> -->
                      <!-- add right margin -->
                      <h5
                        class="font-weight-bold p-1 ml-5"
                        style="font-size: large"
                        id="today_count"
                      >
                      IN:<span id="{{site}}_in">0</span> | OUT:<span id="{{site}}_out">0</span>
                      </h5>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
          <!-- Location -->

          <!-- map  -->
          <!-- <div class="col-2 d-flex "></div> -->

          <div class="col-12">
            <!-- add google map image into div -->
            <!-- <div>
                            <img src="{% static 'images/map.PNG'%}" alt="map" width="100%" height="50%">
                        </div> -->
          </div>
          <!-- <div class="col-1 d-flex "></div> -->
        </div>
        <!-- row -->
        <!-- <div id="map"></div> -->
      </div>
    </div>
  </div>

  <!-- <script src="{% static 'js/apis.js'%}"></script> -->
  <script>
    // {% comment %} document.addEventListener("DOMContentLoaded", function () {
    //     const dropdownButton = document.getElementById("profileDropdownButton");
    //     const dropdownMenu = document.getElementById("profileDropdown");

    //     dropdownButton.addEventListener("click", function () {
    //         // Use Bootstrap's 'show' class to control visibility
    //         dropdownMenu.classList.toggle("show");
    //     });

    //     // Add event listener when the dropdown is shown
    //     dropdownMenu.addEventListener("show.bs.dropdown", function () {
    //         dropdownMenu.classList.add("show");
    //     });

    //     // Add event listener when the dropdown is hidden
    //     dropdownMenu.addEventListener("hide.bs.dropdown", function () {
    //         dropdownMenu.classList.remove("show");
    //     });
    // }); {% endcomment %}
    setInterval(function () {
    var csrf_token = "{{ csrf_token }}";
    console.log(csrf_token)
    $.ajax({
        method: "GET",
        url: "/apis/get_vehicle_counts",
        headers: { "X-CSRFToken": csrf_token },
        data: {
						"user": "{{request.user.id}}",
					},
        success: function (data) {
          let objs = data.data
          for (let key in objs) {
          if (objs.hasOwnProperty(key)) {
            let arr = objs[key];
            document.getElementById(key+'_in_yes').innerHTML = arr[0];
            document.getElementById(key+'_out_yes').innerHTML = arr[1];
            document.getElementById(key+'_in').innerHTML = arr[2];
            document.getElementById(key+'_out').innerHTML = arr[3];
          }
        }
        },
        error: function () {
            console.log("error on get_vehicle_counts");
        }
    });
}, 10000); // 30 seconds in milliseconds

    const socket = io.connect('http://127.0.0.1:7000');
    socket.on('connect', function () {
        console.log('connected');
    });

    socket.on('disconnect', function () {
        console.log('disconnected');
    });

    {% for site in site_name %}
    socket.on('{{site}}', function (data) {
        document.getElementById('{{site}}').src = "data:image/png;base64," + data;
    });
    {% endfor %}
  </script>
</body>
{% endblock %}
